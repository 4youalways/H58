---
output: html_document
editor_options: 
  chunk_output_type: console
---

# load packages
```{r}
library(tidyverse)
library(kableExtra)
library(stringr)
library(janitor)

outdir <- "outputs/plots"

```

# read and style amr and plasmid data
```{r}

plasmid <-
  read_csv("docs/plasmid_data.csv") %>%
  rename("isolate_id" = "isolate id")

plasmid

reads <-
  read_csv("docs/read_accessions.txt") %>%
  clean_names() %>% rename("isolate_id" = "sample")
 
reads

sequencing_overview <-
  read_csv("docs/sequencing_overview.csv") %>%
  clean_names()

sequencing_overview

long_reads <-
  base::merge(sequencing_overview, reads, by = "isolate_id") %>%
  rename("long_read_accession_number" = "accession") %>%
    select(c(isolate_id, year_of_isolation, source, short_read_accession_number,
             long_read_accession_number, assembly_accession)) %>%
             rename("assembly_accession_number" = "assembly_accession")
  
long_reads
# remove underscore from column names
column_names <- long_reads %>%
  names() %>%
  str_replace_all("_", " ") %>%
  str_to_title()

colnames(long_reads) <- column_names


table_1_data <-
  long_reads %>%
  rename("isolate_id" = "Isolate Id")

table_1_data


#data for table 2
assembly_stats <-
  sequencing_overview %>%
  select(isolate_id,
           lineage,
           length_of_assembly,
           gc_percent,
           number_of_contigs,
           n50,
           gc_percent)
assembly_stats
# remove underscore from column names
column_names <- assembly_stats %>%
  names() %>%
  str_replace_all("_", " ") %>%
  str_to_title()

# assign the new column names to the dataframe
colnames(assembly_stats) <- column_names

table_2_data <-
  merge(assembly_stats %>%
      rename("isolate_id" = "Isolate Id"),
      plasmid, by = "isolate_id") %>%
      rename("Isolate Id" = "isolate_id")


```


# draw Table 1

```{r}
options(knitr.kable.NA = '')
table_1 <- table_1_data %>%
  rename("Isolate Id" = "isolate_id") %>%
  knitr::kable(booktabs = TRUE,
               longtable = TRUE,
               linesep = "",
               align = "l",
               escape = FALSE) %>%
  kable_styling(position = "center",
                font_size = 15) %>%
  column_spec(1,
              bold = TRUE)


table_1
```

# save to plot plasmid and amr table
```{r}
plotting_dir <- file.path(outdir, Sys.Date())
plot_name <- file.path(plotting_dir, "Table1.pdf")

if (!dir.exists(plotting_dir)) {dir.create(plotting_dir, recursive = TRUE)}

save_kable(table_1, file = plot_name,
           bs_theme = "simplex",
           density = 10000)


```

# draw Table 2

```{r}
options(knitr.kable.NA = '')
table_2 <- table_2_data %>%
  knitr::kable(booktabs = TRUE,
               longtable = TRUE,
               linesep = "",
               align = "l",
               escape = FALSE,
               "html") %>%
  add_header_above(header =
                     c("","Assembly Stats"= 5, "Plasmid replicons" = 3, "AMR determinants" = 6),
                   font_size = 17) %>%
  kable_styling(position = "center",
                font_size = 14) %>%
  column_spec(1,
              bold = TRUE)


table_2
```

#save table 2
```{r}
plotting_dir <- file.path(outdir, Sys.Date())
plot_name <- file.path(plotting_dir, "Table2.pdf")

if (!dir.exists(plotting_dir)) {dir.create(plotting_dir, recursive = TRUE)}

save_kable(table_2, file = plot_name,
           bs_theme = "simplex")

```


# Save table 1
```{r}
plotting_dir <- file.path(outdir, Sys.Date())
plot_name <- file.path(plotting_dir, "Table1.pdf")

if (!dir.exists(plotting_dir)) {dir.create(plotting_dir, recursive = TRUE)}

save_kable(table_1, file = plot_name,
           bs_theme = "simplex")
```












```{r}

sequencing_overview <-
  read_csv("docs/sequencing_overview.csv") %>%
  clean_names() %>%
  filter(isolate_id != "A53789")

# calculate summary values
mean_length <- mean(sequencing_overview$length_of_assembly)

mean_gc <- mean(sequencing_overview$gc_percent)

table <- sequencing_overview %>% select(isolate_id,
                                        year_of_isolation,
                                        source,
                               long_read_accession,
                               short_read_accession_number,
                               lineage,
                               length_of_assembly,
                               n50,
                               number_of_contigs,
                               gc_percent,
                               presence_of_plasmid)

# remove underscore from column names
column_names <- table %>%
  names() %>%
  str_replace_all("_", " ") %>%
  str_to_title()


# draw the table
y <- table %>%
  knitr::kable(booktabs = TRUE,
               longtable = TRUE,
               linesep = "",
               align = "l",
               escape = FALSE,
    col.names = linebreak(column_names, align = "l")) %>%
  kable_styling(position = "left",
                full_width = FALSE,
                latex_options = c("striped", "repeat_header"),
                stripe_color = "gray")
```


# save isolate metadata to table
```{r}
plotting_dir <- file.path(outdir, Sys.Date())
plot_name <- file.path(plotting_dir, "Table1.png")

if (!dir.exists(plotting_dir)) {dir.create(plotting_dir, recursive = TRUE)}

save_kable(y, file = plot_name,
           bs_theme = "simplex")

```
