---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r}
setwd("./repos/H58")
pacman::p_load(ape,
               ggtree,
               ggnewscale,
               phangorn,
               TreeTools,
               tidyverse,
               janitor,
               plotly,
               viridis)
```




```{r combine_metadata_files, eval=FALSE}
metadata <-
    read_csv("./docs/isolate_metadata.csv") %>%
    select(!c(accession_number))

mykrobe <-
    read.table("./docs/mykrobe.out_predictResults.tsv",
    sep="\t", header=TRUE) %>%
    remove_constant() %>%
    rename("sample_name" = "genome")

#merge the metadata file and mykrobe results
metadata <-
  base::merge(metadata, mykrobe, by = "sample_name",
        all.x = TRUE)

# group isolates into this study and others
metadata$group <-
  case_when(metadata$publication == "Jillian et al. 2021" ~ "This study",
  TRUE ~ "Other")

# group isolates locale into Malawi and other countries
metadata$origin_country <-
  case_when(metadata$country == "Malawi" ~ "Malawi",
  TRUE ~ "Other")

# save metadata to object
save(metadata, file = "./docs/metadata_plus_mykrobe.RData")

#write the metadata to disk
write_csv(metadata,
  file = "./docs/metadata_plus_mykrobe.csv")
```


```{r read_newick_files, eval=FALSE}
#read in the trees

first_tree <-
  ape::read.tree("./outputs/newick/2024-04-19/phylo.aln.treefile")

malawi <-
  ape::read.tree("./outputs/iqtree/malawi/filtered_alignment.fas.treefile")

malawi_no_ref <-
  ape::read.tree("./outputs/iqtree/malawi/phylo.aln.treefile")

global <-
  ape::read.tree("./outputs/iqtree/global/filtered_alignment.fas.treefile")

global_no_ref <-
  ape::read.tree("./outputs/iqtree/global/phylo.aln.treefile")

# save to an R object
save(tree, malawi, malawi_no_ref, global, global_no_ref,
  file = "./data/r/trees.Rdata")
```


```{r}

load("./data/r/trees.Rdata")
load("./docs/metadata_plus_mykrobe.RData")

tree <- tree

tree <- ladderize(tree, right = TRUE)

tree <- midpoint(tree)

tree <- reorder.phylo(tree, order = "cladewise")




p <- ggtree(tree, layout = "rectangular",
  ladderize = TRUE)

p
#p <-
#    p + geom_cladelab(node = 160, label="ERR279153", angle=0) +
#    geom_cladelab(node = 161, label="ERR2602821", angle=0)
# 
# p + geom_hilight(node=161, fill="steelblue", alpha=.6) +
#     geom_hilight(node=160, fill="steelblue", alpha=.6) +
#     geom_cladelab(node = 161)
# p + geom_hilight(mapping = aes(node %in% c(160, 161), fill = S))
# 
# get the node ids for annotation later
# nodeid(tree, label = c("ERR2602821", "ERR360832", "ERR279139", "ERR2602832", "ERR279153"))
```



### color the tips of the tree by country of sample isolation
```{r}
# color the tips of the tree
p1 <-
  p %<+% data +
  theme(legend.position = "right",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(
          size = 12,
          face = "bold",
          hjust = 0.5,
          vjust = -15
        )
  ) +
  geom_tippoint(aes(color=genotype),
                size = 0.5)
p1

tree %>% drop.tip("AL513382.1") %>% ggtree() %<+% data + aes(color = genotype)
```

```{r}
# create heatmap with multiple variables
colors <- c("#f9f6f3", "#3a0177")

outdir <- "outputs/plots"
font_size <- 2


point_mutations <- 
  data %>% select("sample_name", matches(c("par", "gyr"))) %>% remove_constant()

rownames(point_mutations) <- point_mutations$sample_name

point_mutations <- point_mutations %>% select(!sample_name)

point_mutations <- point_mutations %>%
  mutate(across(where(is.integer), as.factor))

# create heatmap for country, and group
group <-
  data %>%
  select(sample_name, group) %>%
  mutate(group = factor(group))

rownames(group) <-
  group$sample_name

group <-
  group %>% select(!sample_name)

# create a country object
data$region <-
  case_when(data$country == "Malawi" ~ "Malawi",
            TRUE ~ "Other")

region <-
  data %>%
  select(sample_name, region) %>%
  mutate(region = factor(region))

rownames(region) <-
  region$sample_name

region <-
  region %>% select(!sample_name)


# heatmap for the year
year <-
  data %>%
  select(sample_name, year) %>%
  mutate(year = factor(year))


rownames(year) <- year$sample_name

year <- year %>% select(!sample_name)

# plasmids

#select columns with plasmids
plasmid_replicons <- 
  c("IncFIAHI1", "IncHI1A", "IncHI1BR27", "IncHI1_ST6", "IncY", "IncFIB_pHCM2",
    "IncFIB_K", "IncN")

plasmid <-
   data %>%
    select("sample_name", all_of(plasmid_replicons))

#set row names to the column for accession_number
rownames(plasmid) <- plasmid$sample_name

# remove accession number column so that the country variable
#has the accession variable as the row nakes
plasmid <- plasmid %>%
    select(!sample_name) %>%
    mutate_at(c("IncFIAHI1", "IncHI1A", "IncHI1BR27"),
    as.factor)


#select columns with amr genes
amr <-
   data %>%
  select("sample_name",
         "blaTEM.1D",
         "blaCTX.M.15",
         "catA1",
         "sul1",
         "sul2",
         "dfrA7",
         "dfrA14",
         "tetA",
         "tetB")
  
#set row names to the column for accession_number
rownames(amr) <- amr$sample_name

amr <- amr %>%
    select(!sample_name) 

genes <- colnames(amr)
amr <- amr %>% mutate_at(genes,
    as.factor)

# qunolone sceptibility
mutations <-
   data %>%
  select("sample_name", contains(c("gyrA_S83F", "gyrB_S464F")))

rownames(mutations) <- mutations$sample_name

mutations <- mutations %>%
    select(!sample_name) 

points <- colnames(mutations)
mutations <- mutations %>% mutate_at(points,
    as.factor)

```


### malawi only


### create a heatmap for the country


# global isolates
this section will plot a tree for the global isolates.

```{r}
tree <- global
tree <- midpoint(tree)
tree <- reorder.phylo(tree, order = "cladewise")

#get tip labels in the current tree
labels <- TipLabels(tree)

#write.csv(labels, file="./docs/tree_labels.csv")

#subset metadata file using the labels in the tree
data <- metadata %>% filter(sample_name %in% c(labels))

# plot parameters
y_offset <- 15
vertical_expansion = c( 0.0002)

# use nodeid() to get the node number for a particular lab

# node_id <-
#   nodeid(tree, c("ERR2602821", "ERR2602832"))
# 
# p <- ggtree(tree, layout = "rectangular",
#   ladderize = TRUE, right = FALSE) +
#   geom_cladelab(node = node_id,
#                 label = "ERR2602832",
#                 align = TRUE,
#                 barcolor = "blue") +
#   geom_tiplab(as_ylab = TRUE)

p <- tree %>%
  drop.tip("AL513382.1") %>%
  ggtree(cex = .2) %<+% data +
  aes(color = genotype)

p
p3 <-
    gheatmap(p, year,
        width = 0.01 ,
        colnames_position = "top",
        colnames_angle = 90,
        colnames_offset_y = y_offset,
        hjust = 0.5,
        font.size = font_size,
        legend_title = "Plasmid Replicons") +
  scale_fill_viridis_d(aesthetics = "fill") +
    labs(fill = "Year") +
  hexpand(.2) +
  vexpand(vertical_expansion) +
  theme(legend.justification = "left") + guides(fill=guide_legend(ncol = 1, byrow = TRUE))

p3

# add the country of isolation
p4 <- p3 + new_scale_fill()

p5 <-
    gheatmap(p4, group,
        width = 0.01 ,
        offset = 0.000004,
        colnames_position = "top",
        colnames_angle = 90,
        colnames_offset_y = y_offset,
        hjust = 0.5,
        font.size = font_size,
        legend_title = "Plasmid Replicons") +
  scale_fill_viridis_d(aesthetics = "fill") +
    labs(fill = "Year") +
  hexpand(.2) +
  vexpand(vertical_expansion) +
  theme(legend.justification = "left")
p5

# add region column

p6 <- p5 + new_scale_fill()

p7 <-
    gheatmap(p6, region,
        width = 0.01 ,
        offset = 0.000002,
        colnames_position = "top",
        colnames_angle = 90,
        colnames_offset_y = y_offset,
        hjust = 0.5,
        font.size = font_size,
        legend_title = "Plasmid Replicons") +
  scale_fill_viridis_d(aesthetics = "fill") +
    labs(fill = "Region") +
  hexpand(.2) +
  vexpand(vertical_expansion) +
  theme(legend.justification = "left")
p7

# extend the tree to include plasmid replicons and amr genes
mbe <-
  cbind(year,plasmid, amr) %>%
  select(c("IncFIAHI1", "IncHI1A", "IncHI1BR27","blaTEM.1D",
         "catA1",
         "sul1",
         "sul2",
         "dfrA7",
         "dfrA14",
         "tetB"))

p8 <- p7 + new_scale_fill()

p9 <-
    gheatmap(p8, mbe,
        width = 0.1,
        offset = 0.000006,
        colnames_position = "top",
        colnames_angle = 90,
        colnames_offset_y = y_offset,
        hjust = 0.5,
        font.size = font_size,
        legend_title = "Plasmid Replicons") +
  scale_fill_viridis_d(
        aesthetics = "fill") +
    labs(fill = "Presence/Absence") +
  hexpand(.2) +
  vexpand(vertical_expansion)

p9


# include point mutation
p10 <- p9 + new_scale_fill()

p11 <-
    gheatmap(p10, point_mutations,
        width = 0.1,
        offset = 0.000017,
        colnames_position = "top",
        colnames_angle = 90,
        colnames_offset_y = y_offset,
        hjust = 0.5,
        font.size = font_size,
        legend_title = "Plasmid Replicons") +
  scale_fill_viridis_d(aesthetics = "fill") +
    labs(fill = "Presence/Absence") +
  hexpand(.2) +
  vexpand(vertical_expansion)

p11 + theme(legend.key.size = unit(.1, "cm")) +
  theme_light(base_size = 5) +
  xlim(NA, 0.00013) +
  ylim(-0.000001, NA)

ggplotly(p3)
```


```{r}
# save the phages
plotting_dir <- file.path(outdir, Sys.Date())
plot_name <- file.path(plotting_dir, "global_tree.svg")

if (!dir.exists(plotting_dir)) {dir.create(plotting_dir, recursive = TRUE)}

svg(plot_name,
    width = 9,
    height = 20)

p11 + theme(legend.key.size = unit(.1, "cm")) + theme_light(base_size = 5) + xlim(NA, 0.00013) + ylim(-0.000001, NA)


dev.off() 



```
